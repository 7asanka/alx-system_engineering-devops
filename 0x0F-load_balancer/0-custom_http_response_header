#!/usr/bin/env bash
# Configure Nginx server with a custom 404 page, redirection, and custom HTTP header

# Update package lists and install Nginx
apt-get update
apt-get install -y nginx

# Allow HTTP traffic
ufw allow 'Nginx HTTP'

# Create the index.html file
echo "Hello World!" > /var/www/html/index.html

# Create the custom 404 page
echo "Ceci n'est pas une page" > /var/www/html/404.html

# Update the Nginx configuration using sed
NGINX_CONF="/etc/nginx/sites-available/default"

# Add the /redirect_me redirection if not already present
if ! grep -q "location = /redirect_me" "$NGINX_CONF"; then
    sed -i "/server_name _;/a \    location = /redirect_me {\n        return 301 https://www.tutorialspoint.com/sql/index.htm;\n    }" "$NGINX_CONF"
fi

# Add the custom 404 error page if not already present
if ! grep -q "error_page 404 /404.html;" "$NGINX_CONF"; then
    sed -i "/server_name _;/a \    error_page 404 /404.html;\n    location = /404.html {\n        internal;\n    }" "$NGINX_CONF"
fi

# Add the custom HTTP response header
if ! grep -q "add_header X-Served-By" "$NGINX_CONF"; then
    sed -i "/server_name _;/a \    location / {\n        add_header X-Served-By \$hostname;\n        try_files \$uri \$uri/ =404;\n    }" "$NGINX_CONF"
fi

sudo service nginx restart
